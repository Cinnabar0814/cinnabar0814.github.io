name: æ„å»ºå¹¶å‘å¸ƒ Docker é•œåƒ

on:
  push:
    branches: [main]
    tags: ['v*.*.*'] # æ‰“ tag æ—¶ä¹Ÿè§¦å‘
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      # è®¾ç½® Node.js ç¯å¢ƒ
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      # è®¾ç½® pnpm
      - name: è®¾ç½® pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      # ç¼“å­˜ pnpm ä¾èµ–
      - name: ç¼“å­˜ pnpm ä¾èµ–
        uses: actions/cache@v5
        with:
          path: |
            ~/.pnpm-store
            node_modules
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      # å®‰è£…ä¾èµ–
      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      # æ„å»ºé¡¹ç›®
      - name: æ„å»ºé¡¹ç›®
        run: pnpm run build

      # éªŒè¯æ„å»ºäº§ç‰©
      - name: éªŒè¯æ„å»ºäº§ç‰©
        run: |
          if [ ! -d "docs" ]; then
            echo "âŒ æ„å»ºå¤±è´¥ï¼šdocs ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          if [ ! -f "docs/index.html" ]; then
            echo "âŒ æ„å»ºå¤±è´¥ï¼šdocs/index.html ä¸å­˜åœ¨"
            exit 1
          fi
          echo "âœ… æ„å»ºäº§ç‰©éªŒè¯é€šè¿‡"
          ls -la docs/

      # è·å–å½“å‰æ—¥æœŸ
      - name: è·å–å½“å‰æ—¥æœŸ
        id: date
        run: echo "date=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT

      # å‡†å¤‡ CI æ„å»ºç¯å¢ƒ
      - name: å‡†å¤‡ CI æ„å»ºç¯å¢ƒ
        run: |
          # ä½¿ç”¨ CI ä¸“ç”¨çš„ dockerignore
          cp .dockerignore.ci .dockerignore
          echo "âœ… å·²åˆ‡æ¢åˆ° CI æ„å»ºæ¨¡å¼"
          echo "ğŸ“ å½“å‰æ„å»ºä¸Šä¸‹æ–‡æ–‡ä»¶ï¼š"
          ls -la | grep -E "(docs|nginx.conf|Dockerfile.ci|\.dockerignore)$"

      # QEMU ç”¨äºæ”¯æŒå¤šæ¶æ„æ„å»ºï¼ˆå¿…é¡»ï¼‰
      - name: è®¾ç½® QEMU
        uses: docker/setup-qemu-action@v3

      # Buildx æ˜¯ç›®å‰å®˜æ–¹å”¯ä¸€æ¨èçš„å¤šæ¶æ„æ„å»ºæ–¹å¼
      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ç™»å½• GHCRï¼ˆå§‹ç»ˆæ‰§è¡Œï¼‰
      - name: ç™»å½• GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # ç™»å½• Docker Hubï¼ˆåªåœ¨ç”¨æˆ·åå­˜åœ¨æ—¶æ‰§è¡Œï¼‰
      - name: ç™»å½• Docker Hub
        if: vars.DOCKERHUB_USERNAME != '' # åªæ£€æŸ¥ varsï¼Œå¿½ç•¥ secrets
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # æ„å»ºå¹¶æ¨é€å¤šæ¶æ„é•œåƒï¼ˆä½¿ç”¨æ„å»ºäº§ç‰©ï¼‰
      - name: æ„å»ºå¹¶æ¨é€å¤šæ¶æ„é•œåƒ
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile.ci
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/ogame-vue-ts:latest
            ghcr.io/${{ github.repository_owner }}/ogame-vue-ts:${{ github.sha }}
            ${{ vars.DOCKERHUB_USERNAME && format('{0}/ogame-vue-ts:latest', vars.DOCKERHUB_USERNAME) || '' }}
            ${{ vars.DOCKERHUB_USERNAME && format('{0}/ogame-vue-ts:{1}', vars.DOCKERHUB_USERNAME, github.sha) || '' }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          labels: |
            org.opencontainers.image.title=OGame Vue Ts
            org.opencontainers.image.description=OGame Vue TypeScript Implementation
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ steps.date.outputs.date }}
